<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆæƒç ç®¡ç† - åˆ›å»ºæˆæƒç </title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        input[type="text"], input[type="checkbox"], select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"] {
            width: 100%;
        }
        input[type="text"][readonly] {
            background-color: #f8f9fa;
            color: #495057;
            font-family: monospace;
            font-weight: bold;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        select {
            width: 100%;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .license-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .field-detail {
            margin: 8px 0;
            padding: 5px 0;
        }
        .field-name {
            font-weight: bold;
            color: #007bff;
        }
        .field-type {
            color: #6c757d;
            font-size: 12px;
        }
        .field-value {
            color: #28a745;
            font-weight: 500;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .license-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .license-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .license-code {
            font-weight: bold;
            color: #007bff;
            font-family: monospace;
        }
        .license-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .status-bound {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”‘ æˆæƒç ç®¡ç† - åˆ›å»ºæˆæƒç </h1>
        
        <div class="section">
            <h2>åˆ›å»ºæ–°æˆæƒç </h2>
            <form id="createForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="licenseCode">æˆæƒç :</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="licenseCode" placeholder="è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æˆæƒç " readonly style="flex: 1;">
                            <button type="button" onclick="generateLicenseCode()" style="padding: 10px 15px; margin: 0;">ç”Ÿæˆæ–°ç </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">æè¿°:</label>
                        <input type="text" id="description" placeholder="æˆæƒç æè¿°">
                    </div>
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="activeStatus">æ¿€æ´»çŠ¶æ€:</label>
                        <select id="activeStatus">
                            <option value="false">æœªæ¿€æ´»</option>
                            <option value="true">å·²æ¿€æ´»</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="boundDevice">ç»‘å®šè®¾å¤‡UUID:</label>
                        <input type="text" id="boundDevice" placeholder="ç•™ç©ºè¡¨ç¤ºæœªç»‘å®š">
                    </div>
                    <div class="form-group">
                        <label for="boundAt">ç»‘å®šæ—¶é—´:</label>
                        <input type="text" id="boundAt" placeholder="ç•™ç©ºè¡¨ç¤ºæœªç»‘å®š">
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="isTestLicense" checked>
                    <label for="isTestLicense">æ ‡è®°ä¸ºæµ‹è¯•æˆæƒç </label>
                </div>
                
                <button type="button" onclick="createLicense()" id="createBtn">åˆ›å»ºæˆæƒç </button>
                <button type="button" onclick="previewLicense()" id="previewBtn">é¢„è§ˆæ ¼å¼</button>
                <button type="button" onclick="clearForm()" id="clearBtn">æ¸…ç©ºè¡¨å•</button>
            </form>
            
            <div id="createResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>æˆæƒç åˆ—è¡¨</h2>
            <button onclick="listAllLicenses()" id="listBtn">åˆ·æ–°åˆ—è¡¨</button>
            <button onclick="clearAllTestLicenses()" id="clearAllBtn">æ¸…é™¤æ‰€æœ‰æµ‹è¯•æˆæƒç </button>
            <div id="licenseList" class="license-list">
                <p>ç‚¹å‡»"åˆ·æ–°åˆ—è¡¨"æŒ‰é’®æ¥æ˜¾ç¤ºæˆæƒç åˆ—è¡¨</p>
            </div>
        </div>
        
        <div class="section">
            <h2>å¿«é€Ÿåˆ›å»ºæµ‹è¯•æˆæƒç </h2>
            <p>ä¸€é”®åˆ›å»ºéšæœºç”Ÿæˆçš„æµ‹è¯•æˆæƒç ï¼š</p>
            <button onclick="createQuickTest('TEST')">åˆ›å»ºæµ‹è¯•æˆæƒç </button>
            <button onclick="createQuickTest('DEMO')">åˆ›å»ºæ¼”ç¤ºæˆæƒç </button>
            <button onclick="createQuickTest('ADMIN')">åˆ›å»ºç®¡ç†æˆæƒç </button>
            <button onclick="createQuickTest('USER')">åˆ›å»ºç”¨æˆ·æˆæƒç </button>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆ—å‡ºæˆæƒç å¹¶ç”Ÿæˆåˆå§‹æˆæƒç 
        document.addEventListener('DOMContentLoaded', () => {
            listAllLicenses();
            generateLicenseCode(); // è‡ªåŠ¨ç”Ÿæˆåˆå§‹æˆæƒç 
        });

        // ç”Ÿæˆå”¯ä¸€æˆæƒç 
        function generateLicenseCode() {
            const licenseCodeInput = document.getElementById('licenseCode');
            
            // ç”Ÿæˆæ ¼å¼: LIC-XXXX-XXXX-XXXX (LIC + 12ä½éšæœºå­—ç¬¦)
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = 'LIC-';
            
            // ç”Ÿæˆ12ä½éšæœºå­—ç¬¦ï¼Œæ¯4ä½ç”¨-åˆ†éš”
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 4 === 0) {
                    code += '-';
                }
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            licenseCodeInput.value = code;
            
            // è‡ªåŠ¨ç”Ÿæˆæè¿°
            const descriptionInput = document.getElementById('description');
            if (!descriptionInput.value) {
                descriptionInput.value = `æˆæƒç  ${code} - è‡ªåŠ¨ç”Ÿæˆ`;
            }
        }

        // æ£€æŸ¥æˆæƒç æ˜¯å¦å·²å­˜åœ¨
        async function checkLicenseExists(licenseCode) {
            try {
                const response = await fetch(
                    `https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses/${licenseCode}`
                );
                return response.ok; // å¦‚æœå­˜åœ¨è¿”å›trueï¼Œä¸å­˜åœ¨è¿”å›false
            } catch (error) {
                return false; // å‡ºé”™æ—¶è®¤ä¸ºä¸å­˜åœ¨
            }
        }

        // ç”Ÿæˆä¸é‡å¤çš„æˆæƒç 
        async function generateUniqueLicenseCode() {
            let attempts = 0;
            const maxAttempts = 10;
            
            while (attempts < maxAttempts) {
                generateLicenseCode();
                const code = document.getElementById('licenseCode').value;
                
                const exists = await checkLicenseExists(code);
                if (!exists) {
                    return code; // æ‰¾åˆ°ä¸é‡å¤çš„æˆæƒç 
                }
                
                attempts++;
            }
            
            // å¦‚æœ10æ¬¡éƒ½é‡å¤ï¼Œä½¿ç”¨æ—¶é—´æˆ³ç¡®ä¿å”¯ä¸€æ€§
            const timestamp = Date.now().toString(36).toUpperCase();
            const uniqueCode = `LIC-${timestamp}-UNIQ`;
            document.getElementById('licenseCode').value = uniqueCode;
            return uniqueCode;
        }

        // åˆ›å»ºæˆæƒç 
        async function createLicense() {
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = 'åˆ›å»ºä¸­...';
            
            try {
                // ç¡®ä¿æˆæƒç æ˜¯å”¯ä¸€çš„
                const licenseCode = await generateUniqueLicenseCode();
                const description = document.getElementById('description').value.trim();
                const activeStatus = document.getElementById('activeStatus').value === 'true';
                const boundDevice = document.getElementById('boundDevice').value.trim();
                const boundAt = document.getElementById('boundAt').value.trim();
                const isTestLicense = document.getElementById('isTestLicense').checked;
                
                if (!licenseCode) {
                    throw new Error('æ— æ³•ç”Ÿæˆå”¯ä¸€æˆæƒç ');
                }
                
                // æ„å»ºæˆæƒç æ•°æ®
                const licenseData = {
                    active: { booleanValue: activeStatus },
                    createdAt: { timestampValue: new Date().toISOString() },
                    testLicense: { booleanValue: isTestLicense }
                };
                
                // æ·»åŠ æè¿°
                if (description) {
                    licenseData.description = { stringValue: description };
                }
                
                // æ·»åŠ ç»‘å®šè®¾å¤‡ä¿¡æ¯
                if (boundDevice) {
                    licenseData.boundDevice = { stringValue: boundDevice };
                } else {
                    licenseData.boundDevice = { nullValue: null };
                }
                
                // æ·»åŠ ç»‘å®šæ—¶é—´
                if (boundAt) {
                    licenseData.boundAt = { timestampValue: boundAt };
                } else {
                    licenseData.boundAt = { nullValue: null };
                }
                
                // å‘é€åˆ°Firebase
                const response = await fetch(
                    `https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses/${licenseCode}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: licenseData
                        })
                    }
                );
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                // æ˜¾ç¤ºåˆ›å»ºç»“æœ
                let resultText = `âœ… æˆæƒç åˆ›å»ºæˆåŠŸ!\n\n`;
                resultText += `æˆæƒç : ${licenseCode}\n`;
                resultText += `å­—æ®µè¯¦æƒ…:\n`;
                
                // æŒ‰ç…§æŒ‡å®šæ ¼å¼æ˜¾ç¤ºå­—æ®µè¯¦æƒ…
                Object.keys(licenseData).forEach(key => {
                    const field = licenseData[key];
                    const fieldType = Object.keys(field)[0];
                    const fieldValue = Object.values(field)[0];
                    
                    resultText += `${key}:\n`;
                    resultText += `  ç±»å‹: ${fieldType}\n`;
                    resultText += `  å€¼: ${fieldValue}\n`;
                });
                
                showResult('createResult', resultText, 'success');
                
                // åˆ·æ–°åˆ—è¡¨
                listAllLicenses();
                
            } catch (error) {
                showResult('createResult', 'åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'åˆ›å»ºæˆæƒç ';
            }
        }

        // é¢„è§ˆæˆæƒç æ ¼å¼
        function previewLicense() {
            const licenseCode = document.getElementById('licenseCode').value.trim();
            const description = document.getElementById('description').value.trim();
            const activeStatus = document.getElementById('activeStatus').value === 'true';
            const boundDevice = document.getElementById('boundDevice').value.trim();
            const boundAt = document.getElementById('boundAt').value.trim();
            const isTestLicense = document.getElementById('isTestLicense').checked;
            
            if (!licenseCode) {
                showResult('createResult', 'è¯·è¾“å…¥æˆæƒç ä»¥é¢„è§ˆæ ¼å¼', 'error');
                return;
            }
            
            let previewText = `é¢„è§ˆæˆæƒç æ ¼å¼:\n\n`;
            previewText += `æˆæƒç : ${licenseCode}\n`;
            previewText += `å­—æ®µè¯¦æƒ…:\n`;
            
            // æ˜¾ç¤ºæ‰€æœ‰å­—æ®µ
            previewText += `active:\n`;
            previewText += `  ç±»å‹: booleanValue\n`;
            previewText += `  å€¼: ${activeStatus}\n`;
            
            previewText += `createdAt:\n`;
            previewText += `  ç±»å‹: timestampValue\n`;
            previewText += `  å€¼: ${new Date().toISOString()}\n`;
            
            previewText += `testLicense:\n`;
            previewText += `  ç±»å‹: booleanValue\n`;
            previewText += `  å€¼: ${isTestLicense}\n`;
            
            if (description) {
                previewText += `description:\n`;
                previewText += `  ç±»å‹: stringValue\n`;
                previewText += `  å€¼: ${description}\n`;
            }
            
            if (boundDevice) {
                previewText += `boundDevice:\n`;
                previewText += `  ç±»å‹: stringValue\n`;
                previewText += `  å€¼: ${boundDevice}\n`;
            } else {
                previewText += `boundDevice:\n`;
                previewText += `  ç±»å‹: nullValue\n`;
                previewText += `  å€¼: null\n`;
            }
            
            if (boundAt) {
                previewText += `boundAt:\n`;
                previewText += `  ç±»å‹: timestampValue\n`;
                previewText += `  å€¼: ${boundAt}\n`;
            } else {
                previewText += `boundAt:\n`;
                previewText += `  ç±»å‹: nullValue\n`;
                previewText += `  å€¼: null\n`;
            }
            
            showResult('createResult', previewText, 'info');
        }

        // æ¸…ç©ºè¡¨å•
        function clearForm() {
            document.getElementById('createForm').reset();
            document.getElementById('isTestLicense').checked = true;
            document.getElementById('createResult').style.display = 'none';
            // é‡æ–°ç”Ÿæˆæˆæƒç 
            generateLicenseCode();
        }

        // å¿«é€Ÿåˆ›å»ºæµ‹è¯•æˆæƒç 
        async function createQuickTest(prefix = 'TEST') {
            // ç”Ÿæˆå”¯ä¸€æˆæƒç 
            await generateUniqueLicenseCode();
            const licenseCode = document.getElementById('licenseCode').value;
            
            // è‡ªåŠ¨å¡«å……è¡¨å•
            document.getElementById('description').value = `æµ‹è¯•æˆæƒç  ${licenseCode} - å¿«é€Ÿåˆ›å»º`;
            document.getElementById('activeStatus').value = 'false';
            document.getElementById('boundDevice').value = '';
            document.getElementById('boundAt').value = '';
            document.getElementById('isTestLicense').checked = true;
            
            // è‡ªåŠ¨åˆ›å»º
            await createLicense();
        }

        // åˆ—å‡ºæ‰€æœ‰æˆæƒç 
        async function listAllLicenses() {
            const listBtn = document.getElementById('listBtn');
            listBtn.disabled = true;
            listBtn.textContent = 'åŠ è½½ä¸­...';
            
            try {
                const response = await fetch(
                    'https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses'
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const licenseList = document.getElementById('licenseList');
                
                if (data.documents && data.documents.length > 0) {
                    let html = '<h3>ç°æœ‰æˆæƒç :</h3>';
                    
                    data.documents.forEach(doc => {
                        const licenseId = doc.name.split('/').pop();
                        const fields = doc.fields || {};
                        
                        const active = fields.active?.booleanValue || false;
                        const boundDevice = fields.boundDevice?.stringValue || null;
                        const createdAt = fields.createdAt?.timestampValue || 'æœªçŸ¥';
                        const description = fields.description?.stringValue || 'æ— æè¿°';
                        const testLicense = fields.testLicense?.booleanValue || false;
                        const boundAt = fields.boundAt?.timestampValue || null;
                        
                        html += `
                            <div class="license-item">
                                <div>
                                    <div class="license-code">${licenseId}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                        ${description}
                                    </div>
                                    <div style="font-size: 11px; color: #888; margin-top: 2px;">
                                        åˆ›å»ºæ—¶é—´: ${new Date(createdAt).toLocaleString()}
                                    </div>
                                    ${boundDevice ? `<div style="font-size: 11px; color: #888; margin-top: 2px;">ç»‘å®šè®¾å¤‡: ${boundDevice}</div>` : ''}
                                </div>
                                <div>
                                    <div class="license-status ${active ? 'status-active' : 'status-inactive'}">
                                        ${active ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»'}
                                    </div>
                                    ${boundDevice ? '<div class="license-status status-bound" style="margin-top: 2px;">å·²ç»‘å®š</div>' : ''}
                                    ${testLicense ? '<div style="font-size: 10px; color: #007bff; margin-top: 2px;">æµ‹è¯•ç </div>' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    licenseList.innerHTML = html;
                } else {
                    licenseList.innerHTML = '<p>æš‚æ— æˆæƒç ï¼Œè¯·å…ˆåˆ›å»ºæˆæƒç ã€‚</p>';
                }
                
            } catch (error) {
                document.getElementById('licenseList').innerHTML = 
                    `<p style="color: red;">åŠ è½½æˆæƒç åˆ—è¡¨å¤±è´¥: ${error.message}</p>`;
            } finally {
                listBtn.disabled = false;
                listBtn.textContent = 'åˆ·æ–°åˆ—è¡¨';
            }
        }

        // æ¸…é™¤æ‰€æœ‰æµ‹è¯•æˆæƒç 
        async function clearAllTestLicenses() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æµ‹è¯•æˆæƒç å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                return;
            }
            
            const clearAllBtn = document.getElementById('clearAllBtn');
            clearAllBtn.disabled = true;
            clearAllBtn.textContent = 'æ¸…é™¤ä¸­...';
            
            try {
                // å…ˆè·å–æ‰€æœ‰æˆæƒç 
                const response = await fetch(
                    'https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses'
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                let clearedCount = 0;
                
                if (data.documents && data.documents.length > 0) {
                    for (const doc of data.documents) {
                        const licenseId = doc.name.split('/').pop();
                        const fields = doc.fields || {};
                        const testLicense = fields.testLicense?.booleanValue || false;
                        
                        if (testLicense) {
                            try {
                                await fetch(
                                    `https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses/${licenseId}`,
                                    {
                                        method: 'DELETE'
                                    }
                                );
                                clearedCount++;
                            } catch (error) {
                                console.error(`æ¸…é™¤æˆæƒç  ${licenseId} å¤±è´¥:`, error);
                            }
                        }
                    }
                }
                
                showResult('createResult', `âœ… å·²æ¸…é™¤ ${clearedCount} ä¸ªæµ‹è¯•æˆæƒç `, 'success');
                listAllLicenses();
                
            } catch (error) {
                showResult('createResult', 'æ¸…é™¤æµ‹è¯•æˆæƒç å¤±è´¥: ' + error.message, 'error');
            } finally {
                clearAllBtn.disabled = false;
                clearAllBtn.textContent = 'æ¸…é™¤æ‰€æœ‰æµ‹è¯•æˆæƒç ';
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>
