<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>授权码管理 - 创建授权码</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        input[type="text"], input[type="checkbox"], select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        input[type="text"] {
            width: 100%;
        }
        input[type="text"][readonly] {
            background-color: #f8f9fa;
            color: #495057;
            font-family: monospace;
            font-weight: bold;
        }
        input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        select {
            width: 100%;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }
        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .license-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        .field-detail {
            margin: 8px 0;
            padding: 5px 0;
        }
        .field-name {
            font-weight: bold;
            color: #007bff;
        }
        .field-type {
            color: #6c757d;
            font-size: 12px;
        }
        .field-value {
            color: #28a745;
            font-weight: 500;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }
        .license-list {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .license-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .license-code {
            font-weight: bold;
            color: #007bff;
            font-family: monospace;
        }
        .license-status {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .status-bound {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔑 授权码管理 - 创建授权码</h1>
        
        <div class="section">
            <h2>创建新授权码</h2>
            <form id="createForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="licenseCode">授权码:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="licenseCode" placeholder="自动生成唯一授权码" readonly style="flex: 1;">
                            <button type="button" onclick="generateLicenseCode()" style="padding: 10px 15px; margin: 0;">生成新码</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="description">描述:</label>
                        <input type="text" id="description" placeholder="授权码描述">
                    </div>
                </div>
                
                <div class="form-row-3">
                    <div class="form-group">
                        <label for="activeStatus">激活状态:</label>
                        <select id="activeStatus">
                            <option value="false">未激活</option>
                            <option value="true">已激活</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="boundDevice">绑定设备UUID:</label>
                        <input type="text" id="boundDevice" placeholder="留空表示未绑定">
                    </div>
                    <div class="form-group">
                        <label for="boundAt">绑定时间:</label>
                        <input type="text" id="boundAt" placeholder="留空表示未绑定">
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="isTestLicense" checked>
                    <label for="isTestLicense">标记为测试授权码</label>
                </div>
                
                <button type="button" onclick="createLicense()" id="createBtn">创建授权码</button>
                <button type="button" onclick="previewLicense()" id="previewBtn">预览格式</button>
                <button type="button" onclick="clearForm()" id="clearBtn">清空表单</button>
            </form>
            
            <div id="createResult" class="result" style="display: none;"></div>
        </div>
        
        <div class="section">
            <h2>授权码列表</h2>
            <button onclick="listAllLicenses()" id="listBtn">刷新列表</button>
            <button onclick="clearAllTestLicenses()" id="clearAllBtn">清除所有测试授权码</button>
            <div id="licenseList" class="license-list">
                <p>点击"刷新列表"按钮来显示授权码列表</p>
            </div>
        </div>
        
        <div class="section">
            <h2>快速创建测试授权码</h2>
            <p>一键创建随机生成的测试授权码：</p>
            <button onclick="createQuickTest('TEST')">创建测试授权码</button>
            <button onclick="createQuickTest('DEMO')">创建演示授权码</button>
            <button onclick="createQuickTest('ADMIN')">创建管理授权码</button>
            <button onclick="createQuickTest('USER')">创建用户授权码</button>
        </div>
    </div>

    <script>
        // 页面加载完成后自动列出授权码并生成初始授权码
        document.addEventListener('DOMContentLoaded', () => {
            listAllLicenses();
            generateLicenseCode(); // 自动生成初始授权码
        });

        // 生成唯一授权码
        function generateLicenseCode() {
            const licenseCodeInput = document.getElementById('licenseCode');
            
            // 生成格式: LIC-XXXX-XXXX-XXXX (LIC + 12位随机字符)
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = 'LIC-';
            
            // 生成12位随机字符，每4位用-分隔
            for (let i = 0; i < 12; i++) {
                if (i > 0 && i % 4 === 0) {
                    code += '-';
                }
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            licenseCodeInput.value = code;
            
            // 自动生成描述
            const descriptionInput = document.getElementById('description');
            if (!descriptionInput.value) {
                descriptionInput.value = `授权码 ${code} - 自动生成`;
            }
        }

        // 检查授权码是否已存在
        async function checkLicenseExists(licenseCode) {
            try {
                const response = await fetch(
                    `https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses/${licenseCode}`
                );
                return response.ok; // 如果存在返回true，不存在返回false
            } catch (error) {
                return false; // 出错时认为不存在
            }
        }

        // 生成不重复的授权码
        async function generateUniqueLicenseCode() {
            let attempts = 0;
            const maxAttempts = 10;
            
            while (attempts < maxAttempts) {
                generateLicenseCode();
                const code = document.getElementById('licenseCode').value;
                
                const exists = await checkLicenseExists(code);
                if (!exists) {
                    return code; // 找到不重复的授权码
                }
                
                attempts++;
            }
            
            // 如果10次都重复，使用时间戳确保唯一性
            const timestamp = Date.now().toString(36).toUpperCase();
            const uniqueCode = `LIC-${timestamp}-UNIQ`;
            document.getElementById('licenseCode').value = uniqueCode;
            return uniqueCode;
        }

        // 创建授权码
        async function createLicense() {
            const createBtn = document.getElementById('createBtn');
            createBtn.disabled = true;
            createBtn.textContent = '创建中...';
            
            try {
                // 确保授权码是唯一的
                const licenseCode = await generateUniqueLicenseCode();
                const description = document.getElementById('description').value.trim();
                const activeStatus = document.getElementById('activeStatus').value === 'true';
                const boundDevice = document.getElementById('boundDevice').value.trim();
                const boundAt = document.getElementById('boundAt').value.trim();
                const isTestLicense = document.getElementById('isTestLicense').checked;
                
                if (!licenseCode) {
                    throw new Error('无法生成唯一授权码');
                }
                
                // 构建授权码数据
                const licenseData = {
                    active: { booleanValue: activeStatus },
                    createdAt: { timestampValue: new Date().toISOString() },
                    testLicense: { booleanValue: isTestLicense }
                };
                
                // 添加描述
                if (description) {
                    licenseData.description = { stringValue: description };
                }
                
                // 添加绑定设备信息
                if (boundDevice) {
                    licenseData.boundDevice = { stringValue: boundDevice };
                } else {
                    licenseData.boundDevice = { nullValue: null };
                }
                
                // 添加绑定时间
                if (boundAt) {
                    licenseData.boundAt = { timestampValue: boundAt };
                } else {
                    licenseData.boundAt = { nullValue: null };
                }
                
                // 发送到Firebase
                const response = await fetch(
                    `https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses/${licenseCode}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            fields: licenseData
                        })
                    }
                );
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const result = await response.json();
                
                // 显示创建结果
                let resultText = `✅ 授权码创建成功!\n\n`;
                resultText += `授权码: ${licenseCode}\n`;
                resultText += `字段详情:\n`;
                
                // 按照指定格式显示字段详情
                Object.keys(licenseData).forEach(key => {
                    const field = licenseData[key];
                    const fieldType = Object.keys(field)[0];
                    const fieldValue = Object.values(field)[0];
                    
                    resultText += `${key}:\n`;
                    resultText += `  类型: ${fieldType}\n`;
                    resultText += `  值: ${fieldValue}\n`;
                });
                
                showResult('createResult', resultText, 'success');
                
                // 刷新列表
                listAllLicenses();
                
            } catch (error) {
                showResult('createResult', '创建失败: ' + error.message, 'error');
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = '创建授权码';
            }
        }

        // 预览授权码格式
        function previewLicense() {
            const licenseCode = document.getElementById('licenseCode').value.trim();
            const description = document.getElementById('description').value.trim();
            const activeStatus = document.getElementById('activeStatus').value === 'true';
            const boundDevice = document.getElementById('boundDevice').value.trim();
            const boundAt = document.getElementById('boundAt').value.trim();
            const isTestLicense = document.getElementById('isTestLicense').checked;
            
            if (!licenseCode) {
                showResult('createResult', '请输入授权码以预览格式', 'error');
                return;
            }
            
            let previewText = `预览授权码格式:\n\n`;
            previewText += `授权码: ${licenseCode}\n`;
            previewText += `字段详情:\n`;
            
            // 显示所有字段
            previewText += `active:\n`;
            previewText += `  类型: booleanValue\n`;
            previewText += `  值: ${activeStatus}\n`;
            
            previewText += `createdAt:\n`;
            previewText += `  类型: timestampValue\n`;
            previewText += `  值: ${new Date().toISOString()}\n`;
            
            previewText += `testLicense:\n`;
            previewText += `  类型: booleanValue\n`;
            previewText += `  值: ${isTestLicense}\n`;
            
            if (description) {
                previewText += `description:\n`;
                previewText += `  类型: stringValue\n`;
                previewText += `  值: ${description}\n`;
            }
            
            if (boundDevice) {
                previewText += `boundDevice:\n`;
                previewText += `  类型: stringValue\n`;
                previewText += `  值: ${boundDevice}\n`;
            } else {
                previewText += `boundDevice:\n`;
                previewText += `  类型: nullValue\n`;
                previewText += `  值: null\n`;
            }
            
            if (boundAt) {
                previewText += `boundAt:\n`;
                previewText += `  类型: timestampValue\n`;
                previewText += `  值: ${boundAt}\n`;
            } else {
                previewText += `boundAt:\n`;
                previewText += `  类型: nullValue\n`;
                previewText += `  值: null\n`;
            }
            
            showResult('createResult', previewText, 'info');
        }

        // 清空表单
        function clearForm() {
            document.getElementById('createForm').reset();
            document.getElementById('isTestLicense').checked = true;
            document.getElementById('createResult').style.display = 'none';
            // 重新生成授权码
            generateLicenseCode();
        }

        // 快速创建测试授权码
        async function createQuickTest(prefix = 'TEST') {
            // 生成唯一授权码
            await generateUniqueLicenseCode();
            const licenseCode = document.getElementById('licenseCode').value;
            
            // 自动填充表单
            document.getElementById('description').value = `测试授权码 ${licenseCode} - 快速创建`;
            document.getElementById('activeStatus').value = 'false';
            document.getElementById('boundDevice').value = '';
            document.getElementById('boundAt').value = '';
            document.getElementById('isTestLicense').checked = true;
            
            // 自动创建
            await createLicense();
        }

        // 列出所有授权码
        async function listAllLicenses() {
            const listBtn = document.getElementById('listBtn');
            listBtn.disabled = true;
            listBtn.textContent = '加载中...';
            
            try {
                const response = await fetch(
                    'https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses'
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const licenseList = document.getElementById('licenseList');
                
                if (data.documents && data.documents.length > 0) {
                    let html = '<h3>现有授权码:</h3>';
                    
                    data.documents.forEach(doc => {
                        const licenseId = doc.name.split('/').pop();
                        const fields = doc.fields || {};
                        
                        const active = fields.active?.booleanValue || false;
                        const boundDevice = fields.boundDevice?.stringValue || null;
                        const createdAt = fields.createdAt?.timestampValue || '未知';
                        const description = fields.description?.stringValue || '无描述';
                        const testLicense = fields.testLicense?.booleanValue || false;
                        const boundAt = fields.boundAt?.timestampValue || null;
                        
                        html += `
                            <div class="license-item">
                                <div>
                                    <div class="license-code">${licenseId}</div>
                                    <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                        ${description}
                                    </div>
                                    <div style="font-size: 11px; color: #888; margin-top: 2px;">
                                        创建时间: ${new Date(createdAt).toLocaleString()}
                                    </div>
                                    ${boundDevice ? `<div style="font-size: 11px; color: #888; margin-top: 2px;">绑定设备: ${boundDevice}</div>` : ''}
                                </div>
                                <div>
                                    <div class="license-status ${active ? 'status-active' : 'status-inactive'}">
                                        ${active ? '已激活' : '未激活'}
                                    </div>
                                    ${boundDevice ? '<div class="license-status status-bound" style="margin-top: 2px;">已绑定</div>' : ''}
                                    ${testLicense ? '<div style="font-size: 10px; color: #007bff; margin-top: 2px;">测试码</div>' : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    licenseList.innerHTML = html;
                } else {
                    licenseList.innerHTML = '<p>暂无授权码，请先创建授权码。</p>';
                }
                
            } catch (error) {
                document.getElementById('licenseList').innerHTML = 
                    `<p style="color: red;">加载授权码列表失败: ${error.message}</p>`;
            } finally {
                listBtn.disabled = false;
                listBtn.textContent = '刷新列表';
            }
        }

        // 清除所有测试授权码
        async function clearAllTestLicenses() {
            if (!confirm('确定要清除所有测试授权码吗？此操作不可撤销！')) {
                return;
            }
            
            const clearAllBtn = document.getElementById('clearAllBtn');
            clearAllBtn.disabled = true;
            clearAllBtn.textContent = '清除中...';
            
            try {
                // 先获取所有授权码
                const response = await fetch(
                    'https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses'
                );

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                let clearedCount = 0;
                
                if (data.documents && data.documents.length > 0) {
                    for (const doc of data.documents) {
                        const licenseId = doc.name.split('/').pop();
                        const fields = doc.fields || {};
                        const testLicense = fields.testLicense?.booleanValue || false;
                        
                        if (testLicense) {
                            try {
                                await fetch(
                                    `https://firestore.googleapis.com/v1/projects/scratch-21d62/databases/(default)/documents/licenses/${licenseId}`,
                                    {
                                        method: 'DELETE'
                                    }
                                );
                                clearedCount++;
                            } catch (error) {
                                console.error(`清除授权码 ${licenseId} 失败:`, error);
                            }
                        }
                    }
                }
                
                showResult('createResult', `✅ 已清除 ${clearedCount} 个测试授权码`, 'success');
                listAllLicenses();
                
            } catch (error) {
                showResult('createResult', '清除测试授权码失败: ' + error.message, 'error');
            } finally {
                clearAllBtn.disabled = false;
                clearAllBtn.textContent = '清除所有测试授权码';
            }
        }

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `result ${type}`;
            element.style.display = 'block';
        }
    </script>
</body>
</html>
