# 套餐和教程选择流程说明

## 功能概述

Voice Assistant 现在支持从 Tutorial API 加载套餐和教程数据，用户可以通过以下流程选择和使用教程：

## 使用流程

### 1. 打开 Popup 界面
- 点击浏览器扩展图标
- 查看"课程套餐"部分

### 2. 选择套餐
- 在套餐列表中点击"选择套餐"按钮
- 系统会自动：
  - 保存套餐选择到本地存储
  - 发送消息给 content script
  - 关闭 popup 窗口

### 3. 在 Scratch 编辑器中使用
- 确保已打开 Scratch 编辑器页面
- 语音助手浮窗会自动加载选中套餐的教程
- 在"选择课程"下拉菜单中查看可用教程

### 4. 选择具体教程
- 从下拉菜单中选择要学习的教程
- 开始使用语音助手进行学习

## 技术实现

### 数据流程
```
Popup 选择套餐 → 
发送 selectPackage 消息 → 
Content Script 接收消息 → 
调用 loadTutorialsForPackage() → 
获取套餐数据 (API) → 
获取教程数据 (API) → 
筛选套餐中的教程 → 
更新下拉选项 UI
```

### API 接口
- **套餐数据**: `GET /api/packages`
- **教程数据**: `GET /api/tutorials`

### 数据格式处理
- 套餐数据：数组格式 `{success: true, data: [...]}`
- 教程数据：数组格式，转换为对象格式以便快速查找
- 支持向后兼容的对象格式

## 错误处理

### 数据不完整情况
当套餐中引用的教程ID在API中不存在时：
- 控制台会显示详细的警告信息
- 下拉菜单会显示可用教程数量统计
- 只显示实际存在的教程选项

### 用户友好提示
- 如果套餐中没有可用教程：显示"该套餐暂无可用课程"
- 如果部分教程缺失：显示"📋 可用课程 (X/Y)"格式的统计信息

## 调试信息

在浏览器开发者工具的控制台中可以看到详细的调试信息：
- 套餐数据获取状态
- 教程数据处理过程
- 教程匹配统计
- 下拉选项生成结果

## 常见问题

### Q: 为什么有些教程显示不出来？
A: 可能是套餐中引用的教程ID在API中不存在，这是数据同步问题，需要检查教程数据的完整性。

### Q: 如何确认套餐选择是否成功？
A: 查看浮窗中的"选择课程"下拉菜单，如果显示了教程列表，说明选择成功。

### Q: 选择套餐后没有反应怎么办？
A: 确保：
1. 已打开 Scratch 编辑器页面
2. 浏览器控制台没有错误信息
3. 网络连接正常，能访问 API

## 开发者注意事项

### 关键文件
- `src/popup/popup.js`: 套餐选择逻辑
- `src/content/main.js`: 教程加载和UI更新
- `src/background/service-worker.js`: API调用处理

### 重要方法
- `selectPackageById()`: Popup中的套餐选择
- `loadTutorialsForPackage()`: Content script中的教程加载
- `renderPackageList()`: 套餐列表渲染

### 数据格式兼容性
代码同时支持数组和对象格式的API响应，确保向后兼容性。
